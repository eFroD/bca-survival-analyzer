# GitLab CI/CD Pipeline for the Survival Analysis Package

stages:
  - lint
  - test
  - build
  - publish

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.pip-cache"
  PYTHON_VERSION: "3.9"

# Cache dependencies to speed up builds
cache:
  paths:
    - .pip-cache/
    - .pytest_cache/
    - .tox/
    - venv/

# Common setup before jobs
.setup_python: &setup_python
  before_script:
    - python -V
    - pip install --upgrade pip
    - pip install -e ".[dev]"

# Linting stage
lint:
  stage: lint
  image: python:$PYTHON_VERSION
  <<: *setup_python
  script:
    - black --check bca_survival tests
    - isort --check bca_survival tests
    - flake8 bca_survival tests
    - mypy bca_survival
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'

# Test stage with coverage report
test:
  stage: test
  image: python:$PYTHON_VERSION
  <<: *setup_python
  script:
    - pytest --cov=bca_survival
    - python -m coverage report
    - python -m coverage xml
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - htmlcov/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'

# Build distribution package
build:
  stage: build
  image: python:$PYTHON_VERSION
  <<: *setup_python
  script:
    - pip install build twine
    - python -m build
    - twine check dist/*
  artifacts:
    paths:
      - dist/*.whl
      - dist/*.tar.gz
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# Publish to GitLab Package Registry
publish:
  stage: publish
  image: python:$PYTHON_VERSION
  script:
    - pip install twine
    - TWINE_PASSWORD=${CI_JOB_TOKEN} TWINE_USERNAME=gitlab-ci-token python -m twine upload --repository-url ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi dist/*
  rules:
    - if: $CI_COMMIT_TAG
  dependencies:
    - build
